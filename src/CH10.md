# CH10 数据库恢复技术 //恢复机制的工作原理：数据冗余 

DB处于一致性状态：DB中的数据满足完整性约束及业务的逻辑规则

事物：
- 数据库操作虚列
- 不可分割的工作单位
- 恢复和并发控制的基本单位

事物的结尾：
- COMMIT         正常提交
- ROLLBACK/ABORT 回滚，异常结束

对事物管理的要求：
- 故障及恢复策略
- 并发调度（封锁机制+可串行化调度）
- 目的：保持ACID四个特性

事务的 4 个特性是什么？举例说明其中的一个特性；
- 原子性（Atomicity）//出故障
	事务的原子性强调了一个事务是一个逻辑工作单元，是一个整体，是不可分割的。一个事务所包含的操作要么全部做，要么全部不做。//2PL协议及其恢复机制
- 一致性（Consistency）//事务的一致性
	一个事务执行一项数据库操作，事务将使数据库从一种一致性的状态变换成另一种一致性状态。 
	在事务执行前，总是假设数据库是一致的，那么当事务成功执行后，数据库肯定仍然是一致的。//可串行化调度/2PL协议
- 隔离性（Isolation）
	如果每个事务单独执行能保持**原子性和一致性**，这些事务并发执行也能保持原子性和一致性，则是事务的隔离性。//封锁机制/时间印协议
- 持续性（Durability ）//出故障
	事务的持久性是指一旦事务成功完成，该事务对数据库所施加的所有更新都是永久的。 //数据库备份技术

故障（不可避免）
- 系统故障
- 认为故障

故障类型有哪些？举例说明；
- 事务内部的故障
	- 可发现
	- 非预期（事物故障仅指此类）
	- 恢复：UNDO（未完成的）
- 系统故障
	称为**软故障**，是指造成系统停止运转的任何事件，使得系统要重新启动。 
	- 整个系统的正常运行突然被破坏
	- 所有正在运行的事务都非正常终止
	- 不破坏数据库
	- 内存中数据库缓冲区的信息全部丢失
	- 恢复：UNDO（未完成的）+REDO（已提交的）  （重启时自动完成）
- 介质故障
	称为**硬故**障，指外存故障
	- 磁盘损坏
	- 磁头碰撞
	- 操作系统的某种潜在错误
	- 瞬时强磁场干扰
	- 恢复：DB备份+UNDO+REDO  （DBA介入）
- 计算机病毒
	- 一种人为的故障或破坏，是一些恶作剧者研制的一种计算机程序
	- 可以繁殖和传播

基于检查点故障恢复策略；日志文件概念；
- 基于检查点故障恢复策略：
  - 步骤
    - 日志文件中增加检查点记录
    - 增加重新开始文件  
  - 检查点记录的内容
    - 正在执行的事物清单
    - 最近的一个日志文件
  - 重新开始文件的内容
    - 记录各个检查点记录在日志文件中的地址   
- 日志文件是用来记录事务对数据库的更新操作的文件。
	- 对于以记录为单位的日志文件，日志文件中需要登记的内容包括：
	  - 各个事务的开始标记。
	  - 各个事务的结束标记。
	  - 各个事务的所有更新操作。
	  - 格式：<Ti,OP,X,V旧，V新>（事务标识，操作类型，操作对象，旧值，新值）
    - 以数据块为单位
      - 事务标识
      - 数据块标识  
    - 按时间次序登记
    - 先写日志文件，后写数据库

故障恢复策略的工作原理：冗余。
- 冗余=DB备份+数据同时存储在DB+日志文件
- 建立方法
  - 数据转储
    - 静态与动态(需要建立日志文件)
    - 海量与增量
  - 登录日志文件 